<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Salgueiros FC – Sorteio Times</title>
<style>
*{box-sizing:border-box;font-family:system-ui,Arial,Helvetica,sans-serif}
body{margin:0;padding:20px;display:flex;gap:20px}
#left{width:40%}
#teams{flex:1;display:flex;gap:20px}
textarea{width:350px;height:60px;margin-bottom:10px;padding:6px;border:1px solid #999;border-radius:4px;resize:vertical}
button{padding:6px 12px;border:0;border-radius:6px;color:#fff;cursor:pointer;margin-right:6px}
#gerar{background:#007bff}
#full{background:#198754}
#sanity{background:#dc3545}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
th{background:#eee}
td.nome{cursor:grab}
tr.picked td{text-decoration:line-through}
tr.unpicked td.nome{color:#d00}
.team{border:1px solid #777;border-radius:6px;padding:8px;flex:1;min-height:300px;display:flex;flex-direction:column;gap:4px}
.slot{border:1px dashed #aaa;border-radius:4px;padding:6px;min-height:24px;cursor:pointer;display:flex;align-items:center;gap:6px}
.slot.filled{border-style:solid;background:#f5f5f5}
.remove{color: red; margin-left:auto;background:none;border:none;font-weight:bold;width:18px;height:18px;line-height:16px;font-size:12px;cursor:pointer}
.skeleton{background:#e0e0e0;position:relative;overflow:hidden}
.skeleton::after{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);animation:load 1.2s infinite}
@keyframes load{0%{left:-100%}50%{left:100%}100%{left:100%}}
.branding{display:flex;align-items:center;margin-top:20px;gap:12px}
.branding img{width:120px;height:120px;border-radius:50%;object-fit:cover}
.branding span{font-size:1.25rem;font-weight:700}
.toggle{margin-left:auto;display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
  <div id="left">
    <textarea id="lista" placeholder="Cole nomes confirmados separados por vírgula"></textarea>
    <div>
      <button id="gerar">Gerar Draft</button>
      <button id="full">Sortear Completo</button>
      <button id="sanity">Sortear com Sanidade</button>
    </div>
    <h3>Pool</h3>
    <table>
      <thead><tr><th>Nome</th><th>T</th><th>Status</th></tr></thead>
      <tbody id="pool"></tbody>
    </table>
    <div class="branding">
      <span>Salgueiros FC</span>
    </div>
  </div>
  <div id="teams"></div>

<script>
const base = [
  {n:"Alê",t:0,s:0},{n:"Nelson",t:0,s:1},{n:"Diego Griep",t:0,s:1},
  {n:"Will",t:0,s:0},{n:"Zé",t:0,s:2},{n:"Salah",t:0,s:1},
  {n:"Lucas Oliveira",t:1,s:0},{n:"João Oliveira",t:1,s:0},{n:"Rafael Mizerani",t:1,s:0},
  {n:"Luciano Jr.",t:1,s:3},{n:"Pretzel",t:1,s:2},{n:"Vicente",t:1,s:2},{n:"Ricardo",t:1,s:1},
  {n:"Thiago Ferreira",t:1,s:1},{n:"Thales Garcia",t:1,s:0},
  {n:"Rafael Esquiçato",t:2,s:1},{n:"Guilherme",t:2,s:2},{n:"Fabio Manzatto",t:2,s:2},
  {n:"Thiago Calazans",t:2,s:2},{n:"Mauricio",t:2,s:1},{n:"Daniel Coutinho",t:2,s:1},
  {n:"Castilho",t:2,s:3},{n:"Olavo",t:2,s:2},{n:"Breno",t:2,s:3},{n:"Deni",t:2,s:2},
  {n:"Thiago Charamba",t:2,s:3},{n:"Thales",t:2,s:3},{n:"Douglas",t:2,s:3},
  {n:"Victor Miranda",t:2,s:3},{n:"Luis",t:2,s:2},
  {n:"Vica",t:2,s:2},{n:"Lucas Araújo",t:2,s:2},{n:"João (vica)",t:3,s:2},
  {n:"Mateus Bolsoni",t:3,s:1},{n:"Thiago Alves",t:3,s:2},
  {n:"Laercio",t:3,s:1},{n:"Brunno Simoes",t:3,s:4},{n:"Tiago Barbosa",t:3,s:1}
];

const shuffle = a => { for (let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a };

function skeleton () {
  const teamsDiv = document.getElementById("teams");
  teamsDiv.innerHTML = "";
  for (let i=0;i<3;i++) {
    const col = document.createElement("div");
    col.className = "team";
    col.innerHTML = '<strong class="skeleton" style="height:18px;width:70px;border-radius:4px"></strong>';
    for (let k=0;k<7;k++) {
      const s = document.createElement("div");
      s.className = "slot skeleton"; s.style.height = "20px";
      col.appendChild(s);
    }
    teamsDiv.appendChild(col);
  }
  const tbody = document.getElementById("pool");
  tbody.innerHTML = "";
  for (let r=0;r<6;r++){
    const tr = document.createElement("tr");
    tr.innerHTML =
      '<td class="skeleton" style="height:18px"></td>' +
      '<td class="skeleton" style="width:40px;height:18px"></td>' +
      '<td class="skeleton" style="width:80px;height:18px"></td>';
    tbody.appendChild(tr);
  }
}

function updatePoolHighlight () {
  const allFull = [...document.querySelectorAll(".team")]
    .every(t=>t.querySelectorAll(".filled").length===7);
  document.querySelectorAll("#pool tr").forEach(tr=>{
    if (allFull && !tr.classList.contains("picked")) tr.classList.add("unpicked");
    else tr.classList.remove("unpicked");
  });
}

function dropHandler (e) {
  e.preventDefault();
  if (this.classList.contains("filled")) return;
  const nome = e.dataTransfer.getData("text/plain");
  const linha = document.getElementById("p_"+nome.replace(/\s+/g,"_"));
  if (!linha || linha.classList.contains("picked")) return;
  this.innerHTML = `<span>${nome}</span><button class="remove">X</button>`;
  this.classList.add("filled");
  linha.classList.add("picked");
  linha.querySelector(".status").textContent = "Escalado";
  updatePoolHighlight();
  this.querySelector(".remove").onclick = () => {
    this.classList.remove("filled");
    this.innerHTML = "";
    linha.classList.remove("picked");
    linha.querySelector(".status").textContent = "Disp.";
    updatePoolHighlight();
  };
}

function render (teams, pool) {
  const teamsDiv = document.getElementById("teams");
  teamsDiv.innerHTML = "";
  teams.forEach((t,i)=>{
    const col = document.createElement("div");
    col.className = "team";
    col.innerHTML = `<strong>Time ${i+1}</strong>`;
    t.forEach(p=>{
      const slot = document.createElement("div");
      slot.className = "slot filled";
      slot.textContent = `${p.n} (Tier ${p.t}) ${p.s}`;
      col.appendChild(slot);
    });
    for (let k=t.length;k<7;k++){
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.ondragover = e=>e.preventDefault();
      slot.ondrop = dropHandler;
      col.appendChild(slot);
    }
    teamsDiv.appendChild(col);
  });
  const tbody = document.getElementById("pool");
  tbody.innerHTML = "";
  pool.forEach(p=>{
    const tr = document.createElement("tr");
    tr.id = "p_"+p.n.replace(/\s+/g,"_");
    tr.innerHTML = `<td class="nome">${p.n}</td><td>${p.t}</td><td class="status">Disp.</td>`;
    tr.querySelector(".nome").draggable = true;
    tr.querySelector(".nome").ondragstart = e=>e.dataTransfer.setData("text/plain",p.n);
    tbody.appendChild(tr);
  });
  updatePoolHighlight();
}

function pushRoundRobinNoSanity(arr, teams, maxSize=7) {
  let i = 0;
  for (const p of arr) {
    let placed = false;
    for (let tries = 0; tries < teams.length; tries++) {
      const idx = (i + tries) % teams.length;
      if (teams[idx].length < maxSize) {
        teams[idx].push(p);
        i = (idx + 1) % teams.length;
        placed = true;
        break;
      }
    }
    if (!placed) {
      const idx = teams.findIndex(t => t.length < maxSize);
      if (idx > -1) teams[idx].push(p);
    }
  }
}

function strengthScore(team){
  let s0=0,s1=0,s2=0,s3=0;
  for (const p of team){
    if (p.t===0) s0++;
    else if (p.t===1) s1++;
    else if (p.t===2) s2++;
    else s3++;
  }
  return s0*3 + s1*2 + s2*1 + s3*0;
}
const isMaluco = p => p.s >= 3;

function rebalanceSanityToStrongTeams(teams){
  let guard = 300;
  while (guard-- > 0){
    const s3 = teams.map(t => t.filter(isMaluco).length);
    const scores = teams.map(strengthScore);
    const maxScore = Math.max(...scores);
    const strong = new Set(scores.map((sc,i)=>sc===maxScore?i:-1).filter(i=>i>-1));
    const offenders = [];
    for (let i=0;i<teams.length;i++){
      if (s3[i] >= 3 && !strong.has(i)) offenders.push(i);
    }
    if (!offenders.length) break;
    let dst=-1,best=Infinity;
    for (const i of strong){
      if (s3[i] < best){ best=s3[i]; dst=i; }
    }
    if (dst===-1) break;
    offenders.sort((a,b)=> (s3[b]-s3[a]) || (scores[a]-scores[b]));
    const src = offenders[0];
    let iM=-1,tMax=-1;
    teams[src].forEach((p,i)=>{ if (isMaluco(p) && p.t>tMax){ tMax=p.t; iM=i; } });
    if (iM===-1) break;
    let iD=-1,tMin=99;
    teams[dst].forEach((p,i)=>{ if (p.s<3 && p.t<tMin){ tMin=p.t; iD=i; } });
    if (iD===-1){
      teams[dst].forEach((p,i)=>{ if (p.t<tMin){ tMin=p.t; iD=i; } });
    }
    if (iD===-1) break;
    const tmp = teams[src][iM];
    teams[src][iM] = teams[dst][iD];
    teams[dst][iD] = tmp;
  }
}

function buildSets(lista){
  const conf = lista.map(x=>x.toLowerCase());
  const oficiais = base.filter(p=>conf.includes(p.n.toLowerCase()));
  const extras = lista
    .filter(n=>!base.some(b=>b.n.toLowerCase()===n.toLowerCase()))
    .map(n=>({n,t:3,s:3}));
  return {oficiais, extras};
}

function draftPrioridade (lista) {
  const {oficiais, extras} = buildSets(lista);
  const t0 = shuffle(oficiais.filter(p=>p.t===0));
  const t1 = shuffle(oficiais.filter(p=>p.t===1));
  const poolCandidatos = shuffle([...oficiais.filter(p=>p.t>1), ...extras]);
  const teams=[[],[],[]];
  pushRoundRobinNoSanity(t0, teams);
  pushRoundRobinNoSanity(t1, teams);
  const alocados = new Set(teams.flat().map(p=>p.n));
  const pool = poolCandidatos.filter(p=>!alocados.has(p.n));
  return {teams,pool};
}

function draftCompleto (lista) {
  const {oficiais, extras} = buildSets(lista);
  const t0 = shuffle(oficiais.filter(p=>p.t===0));
  const t1 = shuffle(oficiais.filter(p=>p.t===1));
  const t2 = shuffle(oficiais.filter(p=>p.t===2));
  const t3 = shuffle([...oficiais.filter(p=>p.t===3), ...extras]);
  const teams=[[],[],[]];
  [t0,t1,t2,t3].forEach(arr => pushRoundRobinNoSanity(arr, teams));
  const alocados = new Set(teams.flat().map(p=>p.n));
  const pool = [...t0,...t1,...t2,...t3].filter(p=>!alocados.has(p.n));
  return {teams,pool};
}

function draftSanidade (lista) {
  const {oficiais, extras} = buildSets(lista);
  const t0 = shuffle(oficiais.filter(p=>p.t===0));
  const t1 = shuffle(oficiais.filter(p=>p.t===1));
  const t2 = shuffle(oficiais.filter(p=>p.t===2));
  const t3 = shuffle([...oficiais.filter(p=>p.t===3), ...extras]);
  const teams=[[],[],[]];
  [t0,t1,t2,t3].forEach(arr => pushRoundRobinNoSanity(arr, teams));
  rebalanceSanityToStrongTeams(teams);
  const alocados = new Set(teams.flat().map(p=>p.n));
  const pool = [...t0,...t1,...t2,...t3].filter(p=>!alocados.has(p.n));
  return {teams,pool};
}

function run (fn) {
  skeleton();
  setTimeout(()=>{
    const lista = document.getElementById("lista").value
                     .split(",").map(s=>s.trim()).filter(Boolean);
    const {teams,pool} = fn(lista.length ? lista : base.map(p=>p.n));
    render(teams,pool);
  }, 400);
}

document.getElementById("gerar").onclick  = () => run(draftPrioridade);
document.getElementById("full").onclick   = () => run(draftCompleto);
document.getElementById("sanity").onclick = () => run(draftSanidade);
</script>
</body>
</html>
